@page "/manager/article/new"
@using Blazorise;
@using Lazcat.Blog.Models.Dtos.Articles
@using Lazcat.Blog.Web.Services.Articles
@layout ManagerLayout
@inject MessageService MessageService
@inject IArticleService ArticleService
@inject IJSRuntime JSRuntime

<Blazorise.Form>
    <Validations Mode="ValidationMode.Auto" Model="@createUpdateArticleInput">
        <Field Horizontal="true">
            <Validation>
                <FieldLabel For="title" ColumnSize="ColumnSize.Is1">
                    <p style="font-size: 16px;">標題:</p>
                </FieldLabel>
                <FieldBody ColumnSize="ColumnSize.Is8">
                    <TextEdit id="title" @bind-Text="@createUpdateArticleInput.Title">
                        <Feedback>
                            <ValidationError />
                        </Feedback>
                    </TextEdit>
                </FieldBody>
            </Validation>
            <FieldLabel For="category" ColumnSize="ColumnSize.Is1">
                <p style="font-size: 16px;">分類:</p>
            </FieldLabel>
            <FieldBody ColumnSize="ColumnSize.Is2">
                <CategoryList CategoryChoose="ChangeCategory" SelectCategory="@(createUpdateArticleInput.CategoryId == 0 ? -2 : createUpdateArticleInput.CategoryId)"></CategoryList>
            </FieldBody>
        </Field>
        <Field>
            <MemoEdit Rows="25" id="PreventTabTextArea" @bind-Text="@createUpdateArticleInput.Content" @onkeydown="AddEditKey"></MemoEdit>
        </Field>
        <Field>
            <Blazorise.Button Color="Color.Success" Type="Blazorise.ButtonType.Submit" Clicked="async () => await SaveArticle()" PreventDefaultOnSubmit="true">
                Save
            </Blazorise.Button>
        </Field>
    </Validations>
</Blazorise.Form>

@code { 
    private CreateUpdateArticleInput createUpdateArticleInput = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await JSRuntime.InvokeVoidAsync("jsinteropFunc.preventTabEvent");
    }

    private async Task SaveArticle()
    {
        var article = await ArticleService.CreateOrUpdateArticle(createUpdateArticleInput);
        if (article.Entity == null)
        {
            await MessageService.Error(article.Message);
            return;
        }
        createUpdateArticleInput.Id = article.Entity.Id;
        await MessageService.Success(article.Message);
    }

    private void ChangeCategory(int id)
    {
        createUpdateArticleInput.CategoryId = id;
    }

    private void AddEditKey(KeyboardEventArgs obj)
    {
        if (obj.Key == "Tab")
        {
            createUpdateArticleInput.Content += "\t";
        }
        Console.WriteLine(obj.Key);
    }

}